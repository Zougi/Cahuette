var gallery=function(){function e(e,t){var n;for(var a in t)n=document.createAttribute("classs"==a?"class":a),void 0!=t[a]&&(n.nodeValue=t[a]),e.setAttributeNode(n);return e}function t(){for(var e,t=document.querySelectorAll(".img"),n=[],a=0;t.length>a;a++)t[a].childNodes.length>1&&(e=t[a].getAttribute("data-src"),e="gallery/"+e,n.push(e));return n}function n(){function n(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText}var a,r=document.getElementById("menu"),o=document.getElementById("content"),l=r.getElementsByTagName("ul")[0];ez_li=l.getElementsByTagName("li"),attr=document.createAttribute("class"),document.getElementById("logbox").className="remove";for(var i=0;ez_li.length>i;i++)a=document.createElement("button"),a.appendChild(document.createTextNode("x")),a.addEventListener("click",function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm("remove "+n+" ?")){var a=new x;a.rm_section(n,function(e){n==A?void 0==e.error&&window.location.reload(!0):l.removeChild(t)})}}),attr=document.createAttribute("title"),attr.nodeValue="remove",a.setAttributeNode(attr),ez_li[i].appendChild(a);var c=document.createElement("input");attr=document.createAttribute("placeholder"),attr.nodeValue="New Categorie",c.setAttributeNode(attr),r.appendChild(c),a=document.createElement("button"),a.addEventListener("click",function(){if(""==c.value)return alert("Supply a category name"),void 0;y(c.value,r,l),a=document.createElement("button"),a.appendChild(document.createTextNode("x")),a.addEventListener("click",function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm("remove "+n+" ?")){var a=new x;a.rm_section(n,function(){l.removeChild(t)})}}),ez_li=l.getElementsByTagName("li"),ez_li[ez_li.length-1].appendChild(a),w(),alert("The new section will be saved after you added one image or more"),window.history.pushState(null,document.title,"#"+c.value),A=c.value,c.value="";var e=document.querySelectorAll("input[type=file]")[0];e.className=e.className.replace(/add_inline|remove/,"")}),a.appendChild(document.createTextNode("add")),r.appendChild(a),a=document.createElement("button"),a.appendChild(document.createTextNode("logout")),a.addEventListener("click",function(){localStorage.clear(),window.location.replace(".")}),r.appendChild(a);var s="bt_upload";0==ez_li.length&&(s+=" remove");var u=e(document.createElement("input"),{type:"file",name:"imgz",multiple:void 0,classs:s});u.addEventListener("change",d,!1),o.appendChild(u);var m=e(document.createElement("progress"),{classs:"remove",value:"0",max:"100"});o.appendChild(m);var g=document.getElementById("gallery");g.addEventListener("dragenter",function(){return"img"==event.target.className?event.target.parentNode.style.opacity=.2:event.target.style.opacity=.2,!1}),g.addEventListener("dragleave",function(e){return e.target.parentNode.style.opacity=1,!1}),g.addEventListener("drop",function(e){return e.target.parentNode.style.opacity=1,d(e)}),a=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_upload bt_del remove",a.setAttributeNode(attr),a.appendChild(document.createTextNode("remove")),a.addEventListener("click",function(){var e=t(),n=new x;n.rm_images(A,e,function(t){if(void 0==t.error){var n,a=window.localStorage.getItem("scroll_landscape_"+A);if(N.remember_scroll_position&&void 0!=a&&(n=JSON.parse(a)),void 0!=n){for(;n.nb_img>k-e.length;)n.nb_img=n.nb_img-1;window.localStorage.setItem("scroll_landscape_"+A,n)}window.location.reload(!0)}})}),o.appendChild(a),a=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_up",a.setAttributeNode(attr),a.appendChild(document.createTextNode(n("&larr; up"))),a.addEventListener("click",function(){var e=t()[0],n=new x;n.move_image(A,e,"up",function(e){void 0==e.error&&window.location.reload(!0)})}),o.appendChild(a),a=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_down",a.setAttributeNode(attr),a.appendChild(document.createTextNode(n("down &rarr;"))),a.addEventListener("click",function(){var e=t()[0],n=new x;n.move_image(A,e,"down",function(e){void 0==e.error&&window.location.reload(!0)})}),o.appendChild(a)}function a(){if(N.admin){var e=localStorage.getItem("token");void 0!=e&&null!=e?n():location.search=="?"+H&&(document.getElementById("logbox").className="add")}}function r(e,t,n){var a=[];for(var r in e)r>=t&&n>r&&a.push(e[r]);return a}function o(e){if(e.lengthComputable){var t=document.querySelectorAll("progress")[0],n=Math.round(100*(e.loaded/e.total));0!=T&&(n=Math.round(100*(n/100/T+O/T))),console.log(n),100>n&&(t.setAttributeNode("value",n+"%"),t.textContent=n+"%")}}function l(e,t,n,a,i,d){t.add_images(a,r(i,0,n),function(){void 0!=d?e():("success"!=resp.response&&console.log(resp),i.length>n?i=r(i,n,i.length):(n=i.length,d=!0),O=++O,l(e,t,n,a,i,d))},o)}function i(){var e=document.querySelectorAll("progress")[0];e.className=e.className.replace(/add|add_inline/,"remove"),c(function(e){I=e,null!=P&&f(I[A])})}function d(e){var t=document.querySelectorAll("progress")[0];t.className=t.className.replace(/remove/,"add"),t.innerHTML="upload in progress...";try{var n=e.target.files||e.dataTransfer.files||e.originalEvent.dataTransfer.files;for(var a in n)if(void 0!=a.type&&!a.type.match("image.*"))return alert("Files must be images"),void 0;var r=new x;r.max_file_upload(function(e){A=A||url_tag||Object.keys(I)[0],void 0!=e.limit&&e.limit<n.length?(T=n.length,l(i,r,parseInt(e.limit),A,n)):(T=0,r.add_images(A,n,function(e){"success"==e.response&&i()},o))})}catch(d){console.log(d)}return e.preventDefault?e.preventDefault():e.returnValue=!1,!1}function c(e){s("storage/gallery.json",e,function(){a()})}function s(e,t,n){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onreadystatechange=function(e){if(e=e.target,4==e.readyState)if(""!=e.responseText){var a=JSON.parse(e.responseText);t(a)}else n()},a.send()}function u(e,t,n){var a=document.createElement("canvas");null!=t?(a.width=Math.round(t*(e.width/e.height)),a.height=t):(a.width=n,a.height=Math.round(n*(e.height/e.width))),(a.width>e.width||a.height>e.height)&&(a.width=e.width,a.height=e.height);var r=a.getContext("2d");return r.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),null!=t&&null!=n?u(a,null,n):a}function m(e,t,n,a){var r=document.createElement("div"),o=document.createAttribute("class");return o.nodeValue="arrow "+(e?"arrow_right":"arrow_left"),r.setAttributeNode(o),o=document.createAttribute("style"),o.nodeValue=e?"margin-left: "+(t/2+F)+Y:"margin-left: -"+(t/2+J+F)+Y,o.nodeValue+="margin-top: "+(window.innerHeight-W)/2+Y,r.setAttributeNode(o),r.addEventListener("click",function(){v(n,a,e)}),r}function g(e,t){var n=new Image;n.onload=function(){for(var n=document.getElementById("fullscreen");n.firstChild&&(void 0==n.firstChild.className||-1==n.firstChild.className.indexOf("load"));)n.removeChild(n.firstChild);var a=n.getElementsByClassName("load")[0];a.className=a.className.replace(/add|add_inline/,"remove");var r=u(this,window.innerHeight,window.innerWidth-2*(J+2*F));n.insertBefore(m(!1,r.width,e,t),n.firstChild);var o=document.createAttribute("style");o.nodeValue="margin-left: -"+r.width/2+Y,o.nodeValue+="margin-top: "+(window.innerHeight-r.height)/2+Y,r.setAttributeNode(o);var l=document.createAttribute("data-src");l.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),r.setAttributeNode(l),n.insertBefore(r,n.firstChild),n.insertBefore(m(!0,r.width,e,t),n.firstChild)},n.src=e}function p(e,t){for(var n=0;t.length>n;n++)if(t[n].getAttribute("data-src")==e)return 0;return-1}function v(e,t,n){var a,r=-1;n&&(r=1);for(var o=document.querySelectorAll(".img"),l=0;t.length>l;l++){var i=t[l+r];if(t[l].url==e){if(void 0==i)if(n)i=t[0],a=0;else{i=t[t.length-1],a=0;for(var l=0;o.length>l;l++)a+=o[l].firstChild.width}g(i.url,t);for(var l=0;o.length>l;l++)if("gallery/"+o[l].getAttribute("data-src")==e){void 0!=a?P.scrollLeft=a:n?P.scrollLeft+=o[l].firstChild.width:P.scrollLeft-=o[l].firstChild.width;break}break}}}function f(e,n,a){var r=document.createElement("div");if(void 0!=e&&null!=P){void 0==n&&(n=0,L=0,S=0,w(),B=[],R=[]),void 0!=a&&a!==!1||e.length==n+1||(D.className=D.className.replace(/add_inline|add|remove/,""),D.className+=" "+(M.matches?"add":"add_inline"));var o=e[n],l=new Image;void 0!=o&&-1==B.indexOf(o.url)&&((void 0==a||a===!1)&&(k=n+1),B=o.url,l.onload=function(o){if(j)return j=!1,void 0;var l,i=window.localStorage.getItem("scroll_landscape_"+A);N.remember_scroll_position&&void 0!=i&&(l=JSON.parse(i)),void 0!=l&&l.time+36e5<Date.now()&&window.localStorage.removeItem("scroll_landscape_"+A);var d=document.createAttribute("data-src");d.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),r.setAttributeNode(d),d=document.createAttribute("class"),d.nodeValue="img",r.setAttributeNode(d);var c=M.matches?u(o.target,null,window.innerWidth):u(o.target,window.innerHeight>V&&N.auto_fit?0==N.max_height||N.max_height>.8*window.innerHeight?.8*window.innerHeight:N.max_height:V);r.appendChild(c);var s=null;r.addEventListener("mouseup",function(e){var n=e.target.parentNode,a=localStorage.getItem("token");if(N.admin&&void 0!=a&&null!=a&&(0==X||X==Q)){1==n.childNodes.length?n.appendChild(document.createElement("span")):n.removeChild(n.lastChild),null==s&&(s=document.querySelectorAll(".bt_up, .bt_down"));for(var r=t().length,o=0;s.length>o;o++)s[o].className=s[o].className.replace(/add_inline|remove/,"")+" "+(1==r?"add_inline":"remove");var l=document.querySelectorAll(".bt_del")[0];r>0?l.className=l.className.replace(/add_inline|remove/,""):l.className+=" remove"}X=Q});var m="";if(r.addEventListener("mousedown",function(e){m=e.screenX+","+e.screenY}),r.addEventListener("mouseup",function(t){var n=localStorage.getItem("token");if((void 0==n||null==n)&&N.fullscreen&&!M.matches&&m==t.screenX+","+t.screenY){var a=document.getElementById("fullscreen");a.className="add",a.addEventListener("click",function(e){if(-1!=e.target.className.indexOf("arrow"))return!1;this.className="remove";var t=a.getElementsByClassName("load")[0];t.className=t.className.replace(/remove/,"add")}),g("gallery/"+t.target.parentNode.getAttribute("data-src"),e)}}),void 0!=a&&a!==!1)R.push(r);else{var v=R.length>0?R.shift():r,h=this.src.substr(this.src.lastIndexOf("/")+1);-1==p(h,document.querySelectorAll(".img"))&&P.insertBefore(v,D)}G=!1,L+=c.width,S+=c.height;var w,y;if(M.matches?(w=S,y=window.innerHeight):(w=L,y=window.innerWidth),e.length!=n+1)if(y>w)f(e,++n);else if(void 0==a||a===!0){var _=!0;null!=l&&l.nb_img>k&&(_=void 0),f(e,++n,_)}void 0==l||a||(P.scrollLeft=l.position),D.className=D.className.replace(/add_inline|add/,"remove")},l.src=o.url)}}function h(e){var t=document.getElementById("menu"),n=t.getElementsByTagName("ul")[0];e=Object.keys(e);for(var a in e)y(e[a],t,n)}function w(){var e=P.getElementsByClassName("img");if(e.length>0)for(;0!=e.length;)P.removeChild(e[e.length-1]);D.className=D.className.replace(/add_inline|add/,"remove")}function y(e,t,n){var a=document.createElement("li"),r=document.createElement("a");r.innerHTML=e;var o=document.createAttribute("href");o.nodeValue="#"+e,r.setAttributeNode(o),r.addEventListener("click",function(){A=e,f(I[e]),localStorage.setItem("section",A)}),a.appendChild(r),n.appendChild(a)}function _(){var e=k||P.getElementsByClassName("img").length,t=I[A].length;t>e&&f(I[A],e,!1)}function E(){var e=window.location.href,t=e.indexOf("#");return-1==t?"":e.substr(t+1)}var N={admin:!0,fullscreen:!0,drag:!0,responsive:!0,remember_scroll_position:!0,min_height:540,max_height:0,auto_fit:!0};if(void 0!=arguments[0]&&"object"==typeof arguments[0])for(var b in N)for(var C in arguments[0])if(b==C){N[b]=arguments[0][C];break}(function(){var t=document.createDocumentFragment(),n=t.appendChild(e(document.createElement("form"),{id:"logbox",classs:"remove"})),a=n.appendChild(document.createElement("fieldset")),r=a.appendChild(document.createElement("legend"));r.appendChild(document.createTextNode("Administration"));var o=e(document.createElement("input"),{id:"login",type:"text",name:"login",placeholder:"Login"});a.appendChild(o),o=e(document.createElement("input"),{id:"password",type:"password",name:"password",placeholder:"Password"}),a.appendChild(o);var l=e(document.createElement("button"),{id:"connect"});l.appendChild(document.createTextNode("Login")),a.appendChild(l),l=e(document.createElement("button"),{id:"close"}),l.appendChild(document.createTextNode("X")),n.appendChild(l);var i=t.appendChild(e(document.createElement("div"),{id:"fullscreen",classs:"remove"})),d=i.appendChild(e(document.createElement("div"),{id:"load_fullscreen",classs:"load add"}));d.appendChild(document.createElement("div")),document.body.appendChild(t);var c=document.getElementById("menu");void 0!=c?c.appendChild(document.createElement("ul")):console.log("menu not found: a div with id 'menu' should be declared");var s=document.getElementById("gallery");if(void 0!=s){t=document.createDocumentFragment();var u=t.appendChild(e(document.createElement("div"),{id:"load_gallery",classs:"load"}));u.appendChild(document.createElement("div")),t.appendChild(e(document.createElement("div"),{style:"clear:both;"})),s.appendChild(t)}else console.log("gallery not found: a div with id 'gallery' should be declared")})();var x=function(){};x.uri=function(){return"api/"},x.http_request=function(e,t,n,a,r){var o=new XMLHttpRequest;o.open(e,t,!0),o.onprogress=r,o.onreadystatechange=function(){if(4==o.readyState){console.log(o.responseText);var e;try{e=JSON.parse(o.responseText)}catch(t){e=null}a(e)}},null!=n?o.send(n):o.send()},x.format_get_data=function(e){var t="",n=!0;for(var a in e)t+=n?"?":"&",t+=a+"="+e[a],n=!1;return t},x.format_post_data=function(e){var t=new FormData;for(var n in e)if("object"==typeof e[n])for(var a=0;e[n].length>a;a++)t.append(n+a,e[n][a]);else t.append(n,e[n]);return t},x.get_ajax=function(e,t,n){if(null!=t){var a=x.format_get_data(t);e+=a}x.http_request("GET",e,null,n)},x.post_ajax=function(e,t,n,a){var r=x.format_post_data(t);x.http_request("POST",e,r,n,a)},x.prototype.login=function(e,t,n){x.get_ajax(x.uri()+"user/login.php",{login:e,password:t},n)},x.prototype.max_file_upload=function(e){x.post_ajax(x.uri()+"max_file_upload.php",{token:localStorage.getItem("token")},e)},x.prototype.add_images=function(e,t,n,a){x.post_ajax(x.uri()+"gallery/add.php",{token:localStorage.getItem("token"),section:e,file:t},n,a)},x.prototype.rm_images=function(e,t,n){x.post_ajax(x.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e,url:t},n)},x.prototype.rm_section=function(e,t){x.post_ajax(x.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e},t)},x.prototype.move_image=function(e,t,n,a){x.post_ajax(x.uri()+"gallery/move.php",{token:localStorage.getItem("token"),section:e,url:t,move:n},a)},document.getElementById("close").addEventListener("click",function(e){return document.getElementById("logbox").className="remove",e.preventDefault?e.preventDefault():e.returnValue=!1,window.history.pushState(null,document.title,".#"+A),!1}),document.getElementById("logbox").addEventListener("submit",function(e){var t=document.getElementById("login").value,a=document.getElementById("password").value,r=new x;return r.login(t,a,function(e){void 0!=e.error?401==e.error?alert("error: login/password incorrect"):alert("error: problem api"):(localStorage.setItem("token",e.token),n(),window.history.pushState(null,document.title,"."))}),e.preventDefault?e.preventDefault():e.returnValue=!1,!1});var I,A,L,S,k,B,T=0,O=0,V=N.min_height,H="login",j=!1,q=document.getElementById("gallery"),D=document.getElementById("load_gallery"),M={matches:!1};N.responsive&&(M=window.matchMedia("only screen and (max-width:480px)"),M.addListener(function(){setTimeout(function(){f(I[A])},100)}));var z=!0;window.onresize=function(){q.offsetWidth>L&&z===!0&&!M.matches&&(_(),z=!1)},document.addEventListener("keyup",function(e){if(37==e.keyCode||39==e.keyCode){var t=document.getElementById("fullscreen").getElementsByTagName("canvas")[0],n="gallery/"+t.getAttribute("data-src");v(n,I[A],39==e.keyCode)}if(27==e.keyCode){var a=document.getElementById("fullscreen");a.className="remove";var r=a.getElementsByClassName("load")[0];r.className=r.className.replace(/remove/,"add")}}),document.addEventListener("keydown",function(e){var t=document.getElementById("fullscreen");-1==t.className.indexOf("remove")&&(e.preventDefault?e.preventDefault():e.returnValue=!1)});var X=0,J=60,W=180,F=20,Y="px;",G=!1,P=document.getElementById("gallery"),R=[];null!=P&&P.addEventListener("scroll",function(){P.scrollWidth-P.offsetWidth<=P.scrollLeft&&!G&&(G=!0,_(),z=!0);var e,t=window.localStorage.getItem("scroll_landscape_"+A);void 0!=t&&(e=JSON.parse(t)),!N.remember_scroll_position||void 0!=e&&e.nb_img>k||window.localStorage.setItem("scroll_landscape_"+A,JSON.stringify({position:P.scrollLeft,nb_img:k,time:Date.now()}))}),window.addEventListener("scroll",function(){M.matches&&(window.pageYOffset!=document.documentElement.scrollHeight-document.documentElement.clientHeight||G||(G=!0,_()))}),A=E(),c(function(e){I=e,h(I);var t=Object.keys(I);A=location.search=="?"+H?localStorage.getItem("section")||t[0]:-1!=t.indexOf(A)?A:t[0],null!=P&&f(I[A]),"function"==typeof a&&a()});var K,Q,P=document.getElementById("gallery");N.drag&&null!=P&&(P.onmousedown=function(e){return K=!1,2!=e.button?(e.screenY<P.parentNode.offsetHeight-5&&(K=!0),Q=e.screenX-this.offsetLeft,!1):void 0},P.onmousemove=function(e){K&&(P.scrollLeft=P.scrollLeft-(e.screenX-Q))},P.onmouseup=function(){K&&(K=!1)})};