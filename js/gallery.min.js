var gallery=function(){function e(){for(var e,t=document.querySelectorAll(".img"),n=[],r=0;t.length>r;r++)t[r].childNodes.length>1&&(e=t[r].getAttribute("data-src"),e="gallery/"+e,n.push(e));return n}function t(){function t(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText}var n,r=document.getElementById("menu"),a=document.getElementById("content"),o=r.getElementsByTagName("ul")[0];ez_li=o.getElementsByTagName("li"),attr=document.createAttribute("class"),document.getElementById("logbox").className="remove";for(var i=0;ez_li.length>i;i++)n=document.createElement("button"),n.appendChild(document.createTextNode("x")),n.addEventListener("click",function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm("remove "+n+" ?")){var r=new E;r.rm_section(n,function(e){n==C?void 0==e.error&&window.location.reload(!0):o.removeChild(t)})}}),attr=document.createAttribute("title"),attr.nodeValue="remove",n.setAttributeNode(attr),ez_li[i].appendChild(n);var d=document.createElement("input");attr=document.createAttribute("placeholder"),attr.nodeValue="New Categorie",d.setAttributeNode(attr),r.appendChild(d),n=document.createElement("button"),n.addEventListener("click",function(){if(""==d.value)return alert("Supply a category name"),void 0;h(d.value,r,o),n=document.createElement("button"),n.appendChild(document.createTextNode("x")),n.addEventListener("click",function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm("remove "+n+" ?")){var r=new E;r.rm_section(n,function(){o.removeChild(t)})}}),ez_li=o.getElementsByTagName("li"),ez_li[ez_li.length-1].appendChild(n),p(),alert("The new section will be saved after you added one image or more"),window.history.pushState(null,document.title,"#"+d.value),C=d.value,d.value="";var e=document.querySelectorAll("input[type=file]")[0];e.className=e.className.replace(/add_inline|remove/,"")}),n.appendChild(document.createTextNode("add")),r.appendChild(n),n=document.createElement("button"),n.appendChild(document.createTextNode("logout")),n.addEventListener("click",function(){localStorage.clear(),window.location.replace(".")}),r.appendChild(n);var c=document.createElement("input");attr=document.createAttribute("type"),attr.nodeValue="file",c.setAttributeNode(attr),attr=document.createAttribute("name"),attr.nodeValue="imgz",c.setAttributeNode(attr),attr=document.createAttribute("multiple"),c.setAttributeNode(attr),attr=document.createAttribute("class");var u="bt_upload";0==ez_li.length&&(u+=" remove"),attr.nodeValue=u,c.setAttributeNode(attr),c.addEventListener("change",l,!1),a.appendChild(c);var s=document.createElement("progress");attr=document.createAttribute("class"),attr.nodeValue="remove",s.setAttributeNode(attr),attr=document.createAttribute("value"),attr.nodeValue=0,s.setAttributeNode(attr),attr=document.createAttribute("max"),attr.nodeValue=100,s.setAttributeNode(attr),a.appendChild(s);var m=document.getElementById("gallery");m.addEventListener("dragenter",function(){return"img"==event.target.className?event.target.parentNode.style.opacity=.2:event.target.style.opacity=.2,!1}),m.addEventListener("dragleave",function(e){return e.target.parentNode.style.opacity=1,!1}),m.addEventListener("drop",function(e){return e.target.parentNode.style.opacity=1,l(e)}),n=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_upload bt_del remove",n.setAttributeNode(attr),n.appendChild(document.createTextNode("remove")),n.addEventListener("click",function(){var t=e(),n=new E;n.rm_images(C,t,function(e){void 0==e.error&&window.location.reload(!0)})}),a.appendChild(n),n=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_up",n.setAttributeNode(attr),n.appendChild(document.createTextNode(t("&larr; up"))),n.addEventListener("click",function(){var t=e()[0],n=new E;n.move_image(C,t,"up",function(e){void 0==e.error&&window.location.reload(!0)})}),a.appendChild(n),n=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_down",n.setAttributeNode(attr),n.appendChild(document.createTextNode(t("down &rarr;"))),n.addEventListener("click",function(){var t=e()[0],n=new E;n.move_image(C,t,"down",function(e){void 0==e.error&&window.location.reload(!0)})}),a.appendChild(n)}function n(){if(b.admin){var e=localStorage.getItem("token");void 0!=e&&null!=e?t():location.search=="?"+V&&(document.getElementById("logbox").className="add")}}function r(e,t,n){var r=[];for(var a in e)a>=t&&n>a&&r.push(e[a]);return r}function a(e){if(e.lengthComputable){var t=document.querySelectorAll("progress")[0],n=Math.round(100*(e.loaded/e.total));0!=S&&(n=Math.round(100*(n/100/S+T/S))),console.log(n),100>n&&(t.setAttribute("value",n+"%"),t.textContent=n+"%")}}function o(e,t,n,i,l,d){t.add_images(i,r(l,0,n),function(){void 0!=d?e():("success"!=resp.response&&console.log(resp),l.length>n?l=r(l,n,l.length):(n=l.length,d=!0),T=++T,o(e,t,n,i,l,d))},a)}function i(){var e=document.querySelectorAll("progress")[0];e.className=e.className.replace(/add|add_inline/,"remove"),d(function(e){A=e,null!=Y&&v(A[C])})}function l(e){var t=document.querySelectorAll("progress")[0];t.className=t.className.replace(/remove/,"add"),t.innerHTML="upload in progress...";try{var n=e.target.files||e.dataTransfer.files||e.originalEvent.dataTransfer.files;for(var r in n)if(void 0!=r.type&&!r.type.match("image.*"))return alert("Files must be images"),void 0;var l=new E;l.max_file_upload(function(e){C=C||url_tag||Object.keys(A)[0],void 0!=e.limit&&e.limit<n.length?(S=n.length,o(i,l,parseInt(e.limit),C,n)):(S=0,l.add_images(C,n,function(e){"success"==e.response&&i()},a))})}catch(d){console.log(d)}return e.preventDefault?e.preventDefault():e.returnValue=!1,!1}function d(e){c("storage/gallery.json",e,function(){n()})}function c(e,t,n){var r=new XMLHttpRequest;r.open("GET",e,!0),r.onreadystatechange=function(e){if(e=e.target,4==e.readyState)if(""!=e.responseText){var r=JSON.parse(e.responseText);t(r)}else n()},r.send()}function u(e,t,n){var r=document.createElement("canvas");null!=t?(r.width=Math.round(t*(e.width/e.height)),r.height=t):(r.width=n,r.height=Math.round(n*(e.height/e.width))),(r.width>e.width||r.height>e.height)&&(r.width=e.width,r.height=e.height);var a=r.getContext("2d");return a.drawImage(e,0,0,e.width,e.height,0,0,r.width,r.height),null!=t&&null!=n?u(r,null,n):r}function s(e,t,n,r){var a=document.createElement("div"),o=document.createAttribute("class");return o.nodeValue="arrow "+(e?"arrow_right":"arrow_left"),a.setAttributeNode(o),o=document.createAttribute("style"),o.nodeValue=e?"margin-left: "+(t/2+W)+X:"margin-left: -"+(t/2+D+W)+X,o.nodeValue+="margin-top: "+(window.innerHeight-z)/2+X,a.setAttributeNode(o),a.addEventListener("click",function(){g(n,r,e)}),a}function m(e,t){var n=new Image;n.onload=function(){for(var n=document.getElementById("fullscreen");n.firstChild;)n.removeChild(n.firstChild);var r=u(this,window.innerHeight,window.innerWidth-2*(D+2*W));n.appendChild(s(!1,r.width,e,t));var a=document.createAttribute("style");a.nodeValue="margin-left: -"+r.width/2+X,a.nodeValue+="margin-top: "+(window.innerHeight-r.height)/2+X,r.setAttributeNode(a);var o=document.createAttribute("data-src");o.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),r.setAttributeNode(o),n.appendChild(r),n.appendChild(s(!0,r.width,e,t))},n.src=e}function g(e,t,n){for(var r=0;t.length>r;r++){var a=t[n?r+1:r-1];if(t[r].url==e&&void 0!=a){m(a.url,t);for(var o=document.querySelectorAll(".img"),r=0;o.length>r;r++)"gallery/"+o[r].getAttribute("data-src")==e&&(n?Y.scrollLeft+=o[r].firstChild.width:Y.scrollLeft-=o[r].firstChild.width);break}}}function v(t,n,r){var a=document.createElement("div");if(void 0!=t&&null!=Y){void 0==n&&(n=0,x=0,I=0,p(),k=[],F=[]),void 0!=r&&r!==!1||t.length==n+1||(H.className=H.className.replace(/add_inline|add|remove/,""),H.className+=" "+(j.matches?"add":"add_inline"));var o=t[n],i=new Image;if(void 0!=o&&-1==k.indexOf(o.url)){(void 0==r||r===!1)&&(L=n+1);var l,d=window.localStorage.getItem("scroll_landscape_"+C);b.remember_scroll_position&&void 0!=d&&(l=JSON.parse(d)),k=o.url,i.onload=function(i){var d=document.createAttribute("data-src");d.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),a.setAttributeNode(d),d=document.createAttribute("class"),d.nodeValue="img",a.setAttributeNode(d);var c=j.matches?u(i.target,null,window.innerWidth):u(i.target,window.innerHeight>B&&b.auto_fit?.8*window.innerHeight:B);a.appendChild(c);var s=null;a.addEventListener("mouseup",function(t){var n=t.target.parentNode,r=localStorage.getItem("token");if(b.admin&&void 0!=r&&null!=r&&(0==M||M==R)){1==n.childNodes.length?n.appendChild(document.createElement("span")):n.removeChild(n.lastChild),null==s&&(s=document.querySelectorAll(".bt_up, .bt_down"));for(var a=e().length,o=0;s.length>o;o++)s[o].className=s[o].className.replace(/add_inline|remove/,"")+" "+(1==a?"add_inline":"remove");var i=document.querySelectorAll(".bt_del")[0];a>0?i.className=i.className.replace(/add_inline|remove/,""):i.className+=" remove"}M=R});var g="";a.addEventListener("mousedown",function(e){g=e.screenX+","+e.screenY}),a.addEventListener("mouseup",function(e){var n=localStorage.getItem("token");if((void 0==n||null==n)&&b.fullscreen&&!j.matches&&g==e.screenX+","+e.screenY){var r=document.getElementById("fullscreen");r.className="add",r.addEventListener("click",function(e){if(-1!=e.target.className.indexOf("arrow"))return!1;this.className="remove";try{for(;this.firstChild;)this.removeChild(this.firstChild)}catch(t){}}),m(o.url,t)}}),void 0!=r&&r!==!1?F.push(a):Y.insertBefore(F.length>0?F.shift():a,H),J=!1,x+=c.width,I+=c.height;var f,p;if(j.matches?(f=I,p=window.innerHeight):(f=x,p=window.innerWidth),t.length!=n+1)if(p>f)v(t,++n);else if(void 0==r||r===!0){var h=!0;null!=l&&l.nb_img>L&&(h=void 0),v(t,++n,h)}void 0!=l&&(Y.scrollLeft=l.position),H.className=H.className.replace(/add_inline|add/,"remove")},i.src=o.url}}}function f(e){var t=document.getElementById("menu"),n=t.getElementsByTagName("ul")[0];e=Object.keys(e);for(var r in e)h(e[r],t,n)}function p(){var e=Y.getElementsByClassName("img");if(e.length>0)for(;0!=e.length;)Y.removeChild(e[e.length-1]);H.className=H.className.replace(/add_inline|add/,"remove")}function h(e,t,n){var r=document.createElement("li"),a=document.createElement("a");a.innerHTML=e;var o=document.createAttribute("href");o.nodeValue="#"+e,a.setAttributeNode(o),a.addEventListener("click",function(){C=e,v(A[e]),localStorage.setItem("section",C)}),r.appendChild(a),n.appendChild(r)}function w(){var e=L||Y.getElementsByClassName("img").length,t=A[C].length;t>e&&v(A[C],e,!1)}function y(){var e=window.location.href,t=e.indexOf("#");return-1==t?"":e.substr(t+1)}var b={admin:!0,fullscreen:!0,drag:!0,responsive:!0,remember_scroll_position:!0,min_height:540,auto_fit:!0};if(void 0!=arguments[0]&&"object"==typeof arguments[0])for(var _ in b)for(var N in arguments[0])if(_==N){b[_]=arguments[0][N];break}var E=function(){};E.uri=function(){return"api/"},E.http_request=function(e,t,n,r,a){var o=new XMLHttpRequest;o.open(e,t,!0),o.onprogress=a,o.onreadystatechange=function(){if(4==o.readyState){console.log(o.responseText);var e;try{e=JSON.parse(o.responseText)}catch(t){e=null}r(e)}},null!=n?o.send(n):o.send()},E.format_get_data=function(e){var t="",n=!0;for(var r in e)t+=n?"?":"&",t+=r+"="+e[r],n=!1;return t},E.format_post_data=function(e){var t=new FormData;for(var n in e)if("object"==typeof e[n])for(var r=0;e[n].length>r;r++)t.append(n+r,e[n][r]);else t.append(n,e[n]);return t},E.get_ajax=function(e,t,n){if(null!=t){var r=E.format_get_data(t);e+=r}E.http_request("GET",e,null,n)},E.post_ajax=function(e,t,n,r){var a=E.format_post_data(t);E.http_request("POST",e,a,n,r)},E.prototype.login=function(e,t,n){E.get_ajax(E.uri()+"user/login.php",{login:e,password:t},n)},E.prototype.max_file_upload=function(e){E.post_ajax(E.uri()+"max_file_upload.php",{token:localStorage.getItem("token")},e)},E.prototype.add_images=function(e,t,n,r){E.post_ajax(E.uri()+"gallery/add.php",{token:localStorage.getItem("token"),section:e,file:t},n,r)},E.prototype.rm_images=function(e,t,n){E.post_ajax(E.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e,url:t},n)},E.prototype.rm_section=function(e,t){E.post_ajax(E.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e},t)},E.prototype.move_image=function(e,t,n,r){E.post_ajax(E.uri()+"gallery/move.php",{token:localStorage.getItem("token"),section:e,url:t,move:n},r)},document.getElementById("close").addEventListener("click",function(e){return document.getElementById("logbox").className="remove",e.preventDefault?e.preventDefault():e.returnValue=!1,window.history.pushState(null,document.title,".#"+C),!1}),document.getElementById("logbox").addEventListener("submit",function(e){var n=document.getElementById("login").value,r=document.getElementById("password").value,a=new E;return a.login(n,r,function(e){void 0!=e.error?401==e.error?alert("error: login/password incorrect"):alert("error: problem api"):(localStorage.setItem("token",e.token),t(),window.history.pushState(null,document.title,"."))}),e.preventDefault?e.preventDefault():e.returnValue=!1,!1});var A,C,x,I,L,k,S=0,T=0,B=b.min_height,V="login",O=document.getElementById("gallery"),H=document.getElementById("load_gallery"),j={matches:!1};b.responsive&&(j=window.matchMedia("only screen and (max-width:480px)"),j.addListener(function(){setTimeout(function(){v(A[C])},100)}));var q=!0;window.onresize=function(){O.offsetWidth>x&&q===!0&&!j.matches&&(w(),q=!1)},document.addEventListener("keyup",function(e){if(37==e.keyCode||39==e.keyCode){var t=document.getElementById("fullscreen").getElementsByTagName("canvas")[0],n="gallery/"+t.getAttribute("data-src");g(n,A[C],39==e.keyCode)}}),document.addEventListener("keydown",function(e){var t=document.getElementById("fullscreen");-1==t.className.indexOf("remove")&&(e.preventDefault?e.preventDefault():e.returnValue=!1)});var M=0,D=60,z=180,W=20,X="px;",J=!1,Y=document.getElementById("gallery"),F=[];null!=Y&&Y.addEventListener("scroll",function(){Y.scrollWidth-Y.offsetWidth<=Y.scrollLeft&&!J&&(J=!0,w(),q=!0);var e,t=window.localStorage.getItem("scroll_landscape_"+C);void 0!=t&&(e=JSON.parse(t)),!b.remember_scroll_position||void 0!=e&&e.nb_img>L&&!(e.nb_img<Y.getElementsByClassName("img").length)||window.localStorage.setItem("scroll_landscape_"+C,JSON.stringify({position:Y.scrollLeft,nb_img:L,time:Date.now()}))}),window.addEventListener("scroll",function(){j.matches&&(window.pageYOffset!=document.documentElement.scrollHeight-document.documentElement.clientHeight||J||(J=!0,w()))}),C=y(),d(function(e){A=e,f(A);var t=Object.keys(A);C=location.search=="?"+V?localStorage.getItem("section")||t[0]:-1!=t.indexOf(C)?C:t[0],null!=Y&&v(A[C]),"function"==typeof n&&n()});var G,R,Y=document.getElementById("gallery");b.drag&&null!=Y&&(Y.onmousedown=function(e){return G=!1,2!=e.button?(e.screenY<Y.parentNode.offsetHeight-5&&(G=!0),R=e.screenX-this.offsetLeft,!1):void 0},Y.onmousemove=function(e){G&&(Y.scrollLeft=Y.scrollLeft-(e.screenX-R)/7)},Y.onmouseup=function(){G&&(G=!1)})};