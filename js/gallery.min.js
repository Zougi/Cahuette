var gallery=function(){function e(e,t){var n;for(var a in t)n=document.createAttribute("classs"==a?"class":a),void 0!=t[a]&&(n.nodeValue=t[a]),e.setAttributeNode(n);return e}function t(){for(var e,t=document.querySelectorAll(".img"),n=[],a=0;t.length>a;a++)t[a].childNodes.length>1&&(e=t[a].getAttribute("data-src"),e="gallery/"+e,n.push(e));return n}function n(){function n(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText}var a,r=document.getElementById("menu"),o=document.getElementById("content"),l=r.getElementsByTagName("ul")[0];ez_li=l.getElementsByTagName("li"),attr=document.createAttribute("class"),document.getElementById("logbox").className="remove";for(var i=0;ez_li.length>i;i++)a=document.createElement("button"),a.appendChild(document.createTextNode("x")),a.addEventListener(C.click,function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm(N.confirm_remove+" "+n+" ?")){var a=new A;a.rm_section(n,function(e){n==k?void 0==e.error&&window.location.reload(!0):l.removeChild(t)})}}),attr=document.createAttribute("title"),attr.nodeValue="remove",a.setAttributeNode(attr),ez_li[i].appendChild(a);var c=document.createElement("input");attr=document.createAttribute("placeholder"),attr.nodeValue=N.new_category,c.setAttributeNode(attr),r.appendChild(c),a=document.createElement("button"),a.addEventListener(C.click,function(){if(""==c.value)return alert(N.error.new_category),void 0;w(c.value,r,l),a=document.createElement("button"),a.appendChild(document.createTextNode("x")),a.addEventListener(C.click,function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm(N.confirm_remove+" "+n+" ?")){var a=new A;a.rm_section(n,function(){l.removeChild(t)})}}),ez_li=l.getElementsByTagName("li"),ez_li[ez_li.length-1].appendChild(a),_(),alert(N.warning.before_add),window.history.pushState(null,document.title,"#"+c.value),k=c.value,c.value="";var e=document.querySelectorAll("input[type=file]")[0];e.className=e.className.replace(/add_inline|remove/,"")}),a.appendChild(document.createTextNode("add")),r.appendChild(a),a=document.createElement("button"),a.appendChild(document.createTextNode("logout")),a.addEventListener(C.click,function(){localStorage.clear(),window.location.replace(".")}),r.appendChild(a);var s="bt_upload";0==ez_li.length&&(s+=" remove");var u=e(document.createElement("input"),{type:"file",name:"imgz",multiple:void 0,classs:s});u.addEventListener("change",d,!1),o.appendChild(u);var m=e(document.createElement("progress"),{classs:"add",value:"0",max:"100"});o.appendChild(m);var g=document.getElementById("gallery");g.addEventListener("dragenter",function(){return"img"==event.target.className?event.target.parentNode.style.opacity=.2:event.target.style.opacity=.2,!1}),g.addEventListener("dragleave",function(e){return e.target.parentNode.style.opacity=1,!1}),g.addEventListener("drop",function(e){return e.target.parentNode.style.opacity=1,d(e)}),a=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_upload bt_del remove",a.setAttributeNode(attr),a.appendChild(document.createTextNode("remove")),a.addEventListener(C.click,function(){var e=t(),n=new A;n.rm_images(k,e,function(t){if(void 0==t.error){var n,a=window.localStorage.getItem("scroll_landscape_"+k);if(E.remember_scroll_position&&void 0!=a&&(n=JSON.parse(a)),void 0!=n){for(;n.nb_img>T-e.length;)n.nb_img=n.nb_img-1;window.localStorage.setItem("scroll_landscape_"+k,n)}window.location.reload(!0)}})}),o.appendChild(a),a=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_up",a.setAttributeNode(attr),a.appendChild(document.createTextNode(n("&larr; up"))),a.addEventListener(C.click,function(){var e=t()[0],n=new A;n.move_image(k,e,"up",function(e){void 0==e.error&&window.location.reload(!0)})}),o.appendChild(a),a=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_down",a.setAttributeNode(attr),a.appendChild(document.createTextNode(n("down &rarr;"))),a.addEventListener(C.click,function(){var e=t()[0],n=new A;n.move_image(k,e,"down",function(e){void 0==e.error&&window.location.reload(!0)})}),o.appendChild(a)}function a(){if(E.admin){var e=localStorage.getItem("token");void 0!=e&&null!=e?n():location.search=="?"+j&&(document.getElementById("logbox").className="add")}}function r(e,t,n){var a=[];for(var r in e)r>=t&&n>r&&a.push(e[r]);return a}function o(e){if(e.lengthComputable){var t=document.querySelectorAll("progress")[0],n=Math.round(100*(e.loaded/e.total));console.log(O+" "+n),0!=O&&(n=Math.round(100*(n/100/O+V/O))),console.log(n),100>n&&(t.setAttributeNode("value",n+"%"),t.textContent=n+"%")}}function l(e,t,n,a,i,d){t.add_images(a,r(i,0,n),function(){void 0!=d?e():("success"!=resp.response&&console.log(resp),i.length>n?i=r(i,n,i.length):(n=i.length,d=!0),V=++V,l(e,t,n,a,i,d))},o)}function i(){var e=document.querySelectorAll("progress")[0];e.className=e.className.replace(/add|add_inline/,"remove"),c(function(e){L=e,null!=R&&f(L[k])})}function d(e){var t=document.querySelectorAll("progress")[0];t.className=t.className.replace(/remove/,"add"),t.innerHTML="upload in progress...";try{var n=e.target.files||e.dataTransfer.files||e.originalEvent.dataTransfer.files;for(var a in n)if(void 0!=a.type&&!a.type.match("image.*"))return alert(N.error.not_images),void 0;var r=new A;r.max_file_upload(function(e){k=k||url_tag||Object.keys(L)[0],void 0!=e.limit&&e.limit<n.length?(O=n.length,l(i,r,parseInt(e.limit),k,n)):(O=0,r.add_images(k,n,function(e){"success"==e.response&&i()},o))})}catch(d){console.log(d)}return e.preventDefault?e.preventDefault():e.returnValue=!1,!1}function c(e){s(E.uri_storage,e,function(){a()})}function s(e,t,n){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onreadystatechange=function(e){if(e=e.target,4==e.readyState)if(""!=e.responseText){var a=JSON.parse(e.responseText);t(a)}else n()},a.send()}function u(e,t,n){var a=document.createElement("canvas");null!=t?(a.width=Math.round(t*(e.width/e.height)),a.height=t):(a.width=n,a.height=Math.round(n*(e.height/e.width))),(a.width>e.width||a.height>e.height)&&(a.width=e.width,a.height=e.height);var r=a.getContext("2d");return r.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),null!=t&&null!=n?u(a,null,n):a}function m(e,t,n,a){var r=document.createElement("div"),o=document.createAttribute("class");return o.nodeValue="arrow "+(e?"arrow_right":"arrow_left"),r.setAttributeNode(o),o=document.createAttribute("style"),o.nodeValue=e?"margin-left: "+(t/2+G)+P:"margin-left: -"+(t/2+F+G)+P,o.nodeValue+="margin-top: "+(window.innerHeight-Y)/2+P,r.setAttributeNode(o),r.addEventListener(C.click,function(){v(n,a,e)}),r}function g(e,t){var n=new Image;n.onload=function(){for(var n=document.getElementById("fullscreen");n.firstChild&&(void 0==n.firstChild.className||-1==n.firstChild.className.indexOf("load"));)n.removeChild(n.firstChild);var a=n.getElementsByClassName("load")[0];a.className=a.className.replace(/add|add_inline/,"remove");var r=u(this,window.innerHeight,window.innerWidth-2*(F+2*G));n.insertBefore(m(!1,r.width,e,t),n.firstChild);var o=document.createAttribute("style");o.nodeValue="margin-left: -"+r.width/2+P,o.nodeValue+="margin-top: "+(window.innerHeight-r.height)/2+P,r.setAttributeNode(o);var l=document.createAttribute("data-src");l.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),r.setAttributeNode(l),n.insertBefore(r,n.firstChild),n.insertBefore(m(!0,r.width,e,t),n.firstChild)},n.src=e}function p(e,t){for(var n=0;t.length>n;n++)if(t[n].getAttribute("data-src")==e)return 0;return-1}function v(e,t,n){var a,r=-1;n&&(r=1);for(var o=document.querySelectorAll(".img"),l=0;t.length>l;l++){var i=t[l+r];if(t[l].url==e){if(void 0==i)if(n)i=t[0],a=0;else{i=t[t.length-1],a=0;for(var l=0;o.length>l;l++)a+=o[l].firstChild.width}g(i.url,t);for(var l=0;o.length>l;l++)if("gallery/"+o[l].getAttribute("data-src")==e){void 0!=a?R.scrollLeft=a:n?R.scrollLeft+=o[l].firstChild.width:R.scrollLeft-=o[l].firstChild.width;break}break}}}function f(e,n,a){var r=document.createElement("div");if(void 0!=e&&null!=R){void 0==n&&(n=0,S=0,B=0,_(),J=[],K=[]),void 0!=a&&a||e.length==n+1||(M.className=M.className.replace(/add_inline|add|remove/,""),M.className+=" "+(z.matches?"add":"add_inline"));var o=e[n],l=new Image;void 0!=o&&(void 0!=a&&a||(T=n+1),l.onload=function(o){if(q)return q=!1,void 0;var l,i=window.localStorage.getItem("scroll_landscape_"+k);E.remember_scroll_position&&void 0!=i&&(l=JSON.parse(i)),void 0!=l&&l.time+36e5<Date.now()&&window.localStorage.removeItem("scroll_landscape_"+k);var d=document.createAttribute("data-src");d.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),r.setAttributeNode(d),d=document.createAttribute("class"),d.nodeValue="img",r.setAttributeNode(d);var c=z.matches?u(o.target,null,window.innerWidth):u(o.target,window.innerHeight>H&&E.auto_fit?0==E.max_height||E.max_height>.8*window.innerHeight?.8*window.innerHeight:E.max_height:H);r.appendChild(c),r.addEventListener(C.start,function(e){var n=localStorage.getItem("token");if(E.admin&&void 0!=n&&null!=n&&(0==W||W==U)){var a=e.target.parentNode;1==a.childNodes.length?a.appendChild(document.createElement("span")):a.removeChild(a.lastChild);var r=document.querySelectorAll(".bt_up, .bt_down"),o=t().length;if(null!=r)for(var l=0;r.length>l;l++)r[l].className=r[l].className.replace(/add_inline|remove/,"")+" "+(1==o?"add_inline":"remove");else console.log(N.warning.no_deplacement_button);var i=document.querySelectorAll(".bt_del")[0];o>0?i.className=i.className.replace(/add_inline|remove/,""):i.className+=" remove"}W=U});var s="";if(r.addEventListener(C.end,function(e){s=e.screenX+","+e.screenY}),r.addEventListener(C.start,function(t){var n=localStorage.getItem("token");if((void 0==n||null==n)&&E.fullscreen&&!z.matches&&s==t.screenX+","+t.screenY){var a=document.getElementById("fullscreen");a.className="add",a.addEventListener(C.click,function(e){if(-1!=e.target.className.indexOf("arrow"))return!1;this.className="remove";var t=a.getElementsByClassName("load")[0];t.className=t.className.replace(/remove/,"add")}),g("gallery/"+t.target.parentNode.getAttribute("data-src"),e)}}),void 0!=a&&a)K.push(r);else{var m=K.length>0?K.shift():r,v=this.src.substr(this.src.lastIndexOf("/")+1);-1==p(v,document.querySelectorAll(".img"))&&-1==J.indexOf(this.src)&&(R.insertBefore(m,M),J.push(this.src))}void 0!=a&&a||(S+=c.width,B+=c.height);var h,_;if(z.matches?(h=B,_=window.innerHeight):(h=S,_=window.innerWidth),e.length!=n+1)if(_>h)f(e,++n);else if(void 0==a||a){var w=!0;null!=l&&l.nb_img>T&&(w=void 0),f(e,++n,w)}void 0==l||a||(R.scrollLeft=l.position),M.className=M.className.replace(/add_inline|add/,"remove")},l.src=o.url)}}function h(e){var t=document.getElementById("menu"),n=t.getElementsByTagName("ul")[0];e=Object.keys(e);for(var a in e)w(e[a],t,n)}function _(){var e=R.getElementsByClassName("img");if(e.length>0)for(;0!=e.length;)R.removeChild(e[e.length-1]);M.className=M.className.replace(/add_inline|add/,"remove")}function w(e,t,n){var a=document.createElement("li"),r=document.createElement("a");r.innerHTML=e;var o=document.createAttribute("href");o.nodeValue="#"+e,r.setAttributeNode(o),r.addEventListener(C.click,function(){k=e,f(L[e]),localStorage.setItem("section",k)}),a.appendChild(r),n.appendChild(a)}function y(){var e=T||R.getElementsByClassName("img").length,t=L[k].length;t>e&&f(L[k],e,!1)}function b(){var e=window.location.href,t=e.indexOf("#");return-1==t?"":e.substr(t+1)}var E={admin:!0,fullscreen:!0,drag:!0,responsive:!0,remember_scroll_position:!0,min_height:540,max_height:0,auto_fit:!0,uri_api:"api/",uri_storage:"storage/gallery.json"},N={logbox:{title:"Administration",login:"Login",password:"Password"},confirm_remove:"remove",new_category:"New Category",warning:{before_add:"The new section will be saved after you added one image or more",no_tag_menu:"menu not found: a div with id 'menu' should be declared"},error:{no_tag_gallery:"gallery not found: a div with id 'gallery' should be declared",login:"error: login/password incorrect",api:"error: problem api",not_images:"Files must be images",no_deplacement_button:"deplacement buttons can't be desplayed because their is no div with class .bt_up/.bt_down in the dom",new_category:"Supply a category name"}},C="ontouchstart"in document?{click:"touchstart",start:"touchstart",end:"touchend",hover:null}:{click:"click",start:"mouseup",end:"mousedown",hover:{start:"mouseenter",end:"mouseleave"}};if(void 0!=arguments[0]&&"object"==typeof arguments[0])for(var x in E)for(var I in arguments[0])if(x==I){E[x]=arguments[0][I];break}(function(){var t=document.createDocumentFragment(),n=t.appendChild(e(document.createElement("form"),{id:"logbox",classs:"remove"})),a=n.appendChild(document.createElement("fieldset")),r=a.appendChild(document.createElement("legend"));r.appendChild(document.createTextNode(N.logbox_title));var o=e(document.createElement("input"),{id:"login",type:"text",name:"login",placeholder:N.logbox.login});a.appendChild(o),o=e(document.createElement("input"),{id:"password",type:"password",name:"password",placeholder:N.logbox.password}),a.appendChild(o);var l=e(document.createElement("button"),{id:"connect"});l.appendChild(document.createTextNode("Login")),a.appendChild(l),l=e(document.createElement("button"),{id:"close"}),l.appendChild(document.createTextNode("X")),n.appendChild(l);var i=t.appendChild(e(document.createElement("div"),{id:"fullscreen",classs:"remove"})),d=i.appendChild(e(document.createElement("div"),{id:"load_fullscreen",classs:"load add"}));d.appendChild(document.createElement("div")),document.body.appendChild(t);var c=document.getElementById("menu");void 0!=c?c.appendChild(document.createElement("ul")):console.log(N.warning.no_menu);var s=document.getElementById("gallery");if(void 0!=s){t=document.createDocumentFragment();var u=t.appendChild(e(document.createElement("div"),{id:"load_gallery",classs:"load"}));u.appendChild(document.createElement("div")),t.appendChild(e(document.createElement("div"),{style:"clear:both;"})),s.appendChild(t)}else console.log(N.error.no_tag_gallery)})();var A=function(){};A.uri=function(){return E.uri_api},A.http_request=function(e,t,n,a,r){var o=new XMLHttpRequest;o.open(e,t,!0),o.onprogress=r,o.onreadystatechange=function(){if(4==o.readyState){console.log(o.responseText);var e;try{e=JSON.parse(o.responseText)}catch(t){e=null}a(e)}},null!=n?o.send(n):o.send()},A.format_get_data=function(e){var t="",n=!0;for(var a in e)t+=n?"?":"&",t+=a+"="+e[a],n=!1;return t},A.format_post_data=function(e){var t=new FormData;for(var n in e)if("object"==typeof e[n])for(var a=0;e[n].length>a;a++)t.append(n+a,e[n][a]);else t.append(n,e[n]);return t},A.get_ajax=function(e,t,n){if(null!=t){var a=A.format_get_data(t);e+=a}A.http_request("GET",e,null,n)},A.post_ajax=function(e,t,n,a){var r=A.format_post_data(t);A.http_request("POST",e,r,n,a)},A.prototype.login=function(e,t,n){A.get_ajax(A.uri()+"user/login.php",{login:e,password:t},n)},A.prototype.max_file_upload=function(e){A.post_ajax(A.uri()+"max_file_upload.php",{token:localStorage.getItem("token")},e)},A.prototype.add_images=function(e,t,n,a){A.post_ajax(A.uri()+"gallery/add.php",{token:localStorage.getItem("token"),section:e,file:t},n,a)},A.prototype.rm_images=function(e,t,n){A.post_ajax(A.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e,url:t},n)},A.prototype.rm_section=function(e,t){A.post_ajax(A.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e},t)},A.prototype.move_image=function(e,t,n,a){A.post_ajax(A.uri()+"gallery/move.php",{token:localStorage.getItem("token"),section:e,url:t,move:n},a)},document.getElementById("close").addEventListener(C.click,function(e){return document.getElementById("logbox").className="remove",e.preventDefault?e.preventDefault():e.returnValue=!1,window.history.pushState(null,document.title,".#"+k),!1}),document.getElementById("logbox").addEventListener("submit",function(e){var t=document.getElementById("login").value,a=document.getElementById("password").value,r=new A;return r.login(t,a,function(e){void 0!=e.error?401==e.error?alert(N.error.login):alert(N.error.api):(localStorage.setItem("token",e.token),n(),window.history.pushState(null,document.title,"."))}),e.preventDefault?e.preventDefault():e.returnValue=!1,!1});var L,k,S,B,T,O=0,V=0,H=E.min_height,j="login",q=!1,D=document.getElementById("gallery"),M=document.getElementById("load_gallery"),z={matches:!1};E.responsive&&(z=window.matchMedia("only screen and (max-width:480px)"),z.addListener(function(){setTimeout(function(){f(L[k])},100)}));var X=!0;window.onresize=function(){D.offsetWidth>S&&X&&!z.matches&&(y(),X=!1)},document.addEventListener("keyup",function(e){if(37==e.keyCode||39==e.keyCode){var t=document.getElementById("fullscreen").getElementsByTagName("canvas")[0],n="gallery/"+t.getAttribute("data-src");v(n,L[k],39==e.keyCode)}if(27==e.keyCode){var a=document.getElementById("fullscreen");a.className="remove";var r=a.getElementsByClassName("load")[0];r.className=r.className.replace(/remove/,"add")}}),document.addEventListener("keydown",function(e){var t=document.getElementById("fullscreen");-1==t.className.indexOf("remove")&&(e.preventDefault?e.preventDefault():e.returnValue=!1)});var J,W=0,F=60,Y=180,G=20,P="px;",R=document.getElementById("gallery"),K=[];null!=R&&R.addEventListener("scroll",function(){R.scrollWidth-R.offsetWidth<=R.scrollLeft&&(y(),X=!0);var e,t=window.localStorage.getItem("scroll_landscape_"+k);void 0!=t&&(e=JSON.parse(t)),!E.remember_scroll_position||void 0!=e&&e.nb_img>T||window.localStorage.setItem("scroll_landscape_"+k,JSON.stringify({position:R.scrollLeft,nb_img:T,time:Date.now()}))}),window.addEventListener("scroll",function(){z.matches&&window.pageYOffset==document.documentElement.scrollHeight-document.documentElement.clientHeight&&y()}),k=b(),c(function(e){L=e,h(L);var t=Object.keys(L);k=location.search=="?"+j?localStorage.getItem("section")||t[0]:-1!=t.indexOf(k)?k:t[0],null!=R&&f(L[k]),"function"==typeof a&&a()});var Q,U,R=document.getElementById("gallery");E.drag&&null!=R&&(R.onmousedown=function(e){return Q=!1,2!=e.button?(e.screenY<R.parentNode.offsetHeight-5&&(Q=!0),U=e.screenX-this.offsetLeft,!1):void 0},R.onmousemove=function(e){Q&&(R.scrollLeft=R.scrollLeft-(e.screenX-U))},R.onmouseup=function(){Q&&(Q=!1)})};