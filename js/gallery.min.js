var gallery=function(){function e(){for(var e,t=document.querySelectorAll(".img"),n=[],r=0;t.length>r;r++)t[r].childNodes.length>1&&(e=t[r].getAttribute("data-src"),e="gallery/"+e,n.push(e));return n}function t(){function t(e){var t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText}var n,r=document.getElementById("menu"),a=document.getElementById("content"),o=r.getElementsByTagName("ul")[0];ez_li=o.getElementsByTagName("li"),attr=document.createAttribute("class"),document.getElementById("logbox").className="remove";for(var l=0;ez_li.length>l;l++)n=document.createElement("button"),n.appendChild(document.createTextNode("x")),n.addEventListener("click",function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm("remove "+n+" ?")){var r=new A;r.rm_section(n,function(e){n==x?void 0==e.error&&window.location.reload(!0):o.removeChild(t)})}}),attr=document.createAttribute("title"),attr.nodeValue="remove",n.setAttributeNode(attr),ez_li[l].appendChild(n);var d=document.createElement("input");attr=document.createAttribute("placeholder"),attr.nodeValue="New Categorie",d.setAttributeNode(attr),r.appendChild(d),n=document.createElement("button"),n.addEventListener("click",function(){if(""==d.value)return alert("Supply a category name"),void 0;w(d.value,r,o),n=document.createElement("button"),n.appendChild(document.createTextNode("x")),n.addEventListener("click",function(e){var t=e.target.parentNode,n=t.getElementsByTagName("a")[0].innerHTML;if(confirm("remove "+n+" ?")){var r=new A;r.rm_section(n,function(){o.removeChild(t)})}}),ez_li=o.getElementsByTagName("li"),ez_li[ez_li.length-1].appendChild(n),h(),alert("The new section will be saved after you added one image or more"),window.history.pushState(null,document.title,"#"+d.value),x=d.value,d.value="";var e=document.querySelectorAll("input[type=file]")[0];e.className=e.className.replace(/add_inline|remove/,"")}),n.appendChild(document.createTextNode("add")),r.appendChild(n),n=document.createElement("button"),n.appendChild(document.createTextNode("logout")),n.addEventListener("click",function(){localStorage.clear(),window.location.replace(".")}),r.appendChild(n);var c=document.createElement("input");attr=document.createAttribute("type"),attr.nodeValue="file",c.setAttributeNode(attr),attr=document.createAttribute("name"),attr.nodeValue="imgz",c.setAttributeNode(attr),attr=document.createAttribute("multiple"),c.setAttributeNode(attr),attr=document.createAttribute("class");var s="bt_upload";0==ez_li.length&&(s+=" remove"),attr.nodeValue=s,c.setAttributeNode(attr),c.addEventListener("change",i,!1),a.appendChild(c);var u=document.createElement("progress");attr=document.createAttribute("class"),attr.nodeValue="remove",u.setAttributeNode(attr),attr=document.createAttribute("value"),attr.nodeValue=0,u.setAttributeNode(attr),attr=document.createAttribute("max"),attr.nodeValue=100,u.setAttributeNode(attr),a.appendChild(u);var m=document.getElementById("gallery");m.addEventListener("dragenter",function(){return"img"==event.target.className?event.target.parentNode.style.opacity=.2:event.target.style.opacity=.2,!1}),m.addEventListener("dragleave",function(e){return e.target.parentNode.style.opacity=1,!1}),m.addEventListener("drop",function(e){return e.target.parentNode.style.opacity=1,i(e)}),n=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_upload bt_del remove",n.setAttributeNode(attr),n.appendChild(document.createTextNode("remove")),n.addEventListener("click",function(){var t=e(),n=new A;n.rm_images(x,t,function(e){if(void 0==e.error){var n,r=window.localStorage.getItem("scroll_landscape_"+x);if(b.remember_scroll_position&&void 0!=r&&(n=JSON.parse(r)),void 0!=n){for(;n.nb_img>L-t.length;)n.nb_img=n.nb_img-1;window.localStorage.setItem("scroll_landscape_"+x,n)}window.location.reload(!0)}})}),a.appendChild(n),n=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_up",n.setAttributeNode(attr),n.appendChild(document.createTextNode(t("&larr; up"))),n.addEventListener("click",function(){var t=e()[0],n=new A;n.move_image(x,t,"up",function(e){void 0==e.error&&window.location.reload(!0)})}),a.appendChild(n),n=document.createElement("button"),attr=document.createAttribute("class"),attr.nodeValue="bt_down",n.setAttributeNode(attr),n.appendChild(document.createTextNode(t("down &rarr;"))),n.addEventListener("click",function(){var t=e()[0],n=new A;n.move_image(x,t,"down",function(e){void 0==e.error&&window.location.reload(!0)})}),a.appendChild(n)}function n(){if(b.admin){var e=localStorage.getItem("token");void 0!=e&&null!=e?t():location.search=="?"+O&&(document.getElementById("logbox").className="add")}}function r(e,t,n){var r=[];for(var a in e)a>=t&&n>a&&r.push(e[a]);return r}function a(e){if(e.lengthComputable){var t=document.querySelectorAll("progress")[0],n=Math.round(100*(e.loaded/e.total));0!=B&&(n=Math.round(100*(n/100/B+T/B))),console.log(n),100>n&&(t.setAttribute("value",n+"%"),t.textContent=n+"%")}}function o(e,t,n,l,i,d){t.add_images(l,r(i,0,n),function(){void 0!=d?e():("success"!=resp.response&&console.log(resp),i.length>n?i=r(i,n,i.length):(n=i.length,d=!0),T=++T,o(e,t,n,l,i,d))},a)}function l(){var e=document.querySelectorAll("progress")[0];e.className=e.className.replace(/add|add_inline/,"remove"),d(function(e){C=e,null!=G&&f(C[x])})}function i(e){var t=document.querySelectorAll("progress")[0];t.className=t.className.replace(/remove/,"add"),t.innerHTML="upload in progress...";try{var n=e.target.files||e.dataTransfer.files||e.originalEvent.dataTransfer.files;for(var r in n)if(void 0!=r.type&&!r.type.match("image.*"))return alert("Files must be images"),void 0;var i=new A;i.max_file_upload(function(e){x=x||url_tag||Object.keys(C)[0],void 0!=e.limit&&e.limit<n.length?(B=n.length,o(l,i,parseInt(e.limit),x,n)):(B=0,i.add_images(x,n,function(e){"success"==e.response&&l()},a))})}catch(d){console.log(d)}return e.preventDefault?e.preventDefault():e.returnValue=!1,!1}function d(e){c("storage/gallery.json",e,function(){n()})}function c(e,t,n){var r=new XMLHttpRequest;r.open("GET",e,!0),r.onreadystatechange=function(e){if(e=e.target,4==e.readyState)if(""!=e.responseText){var r=JSON.parse(e.responseText);t(r)}else n()},r.send()}function s(e,t,n){var r=document.createElement("canvas");null!=t?(r.width=Math.round(t*(e.width/e.height)),r.height=t):(r.width=n,r.height=Math.round(n*(e.height/e.width))),(r.width>e.width||r.height>e.height)&&(r.width=e.width,r.height=e.height);var a=r.getContext("2d");return a.drawImage(e,0,0,e.width,e.height,0,0,r.width,r.height),null!=t&&null!=n?s(r,null,n):r}function u(e,t,n,r){var a=document.createElement("div"),o=document.createAttribute("class");return o.nodeValue="arrow "+(e?"arrow_right":"arrow_left"),a.setAttributeNode(o),o=document.createAttribute("style"),o.nodeValue=e?"margin-left: "+(t/2+X)+Y:"margin-left: -"+(t/2+J+X)+Y,o.nodeValue+="margin-top: "+(window.innerHeight-W)/2+Y,a.setAttributeNode(o),a.addEventListener("click",function(){v(n,r,e)}),a}function m(e,t){var n=new Image;n.onload=function(){for(var n=document.getElementById("fullscreen");n.firstChild&&(void 0==n.firstChild.className||-1==n.firstChild.className.indexOf("load"));)n.removeChild(n.firstChild);var r=n.getElementsByClassName("load")[0];r.className=r.className.replace(/add|add_inline/,"remove");var a=s(this,window.innerHeight,window.innerWidth-2*(J+2*X));n.insertBefore(u(!1,a.width,e,t),n.firstChild);var o=document.createAttribute("style");o.nodeValue="margin-left: -"+a.width/2+Y,o.nodeValue+="margin-top: "+(window.innerHeight-a.height)/2+Y,a.setAttributeNode(o);var l=document.createAttribute("data-src");l.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),a.setAttributeNode(l),n.insertBefore(a,n.firstChild),n.insertBefore(u(!0,a.width,e,t),n.firstChild)},n.src=e}function g(e,t){for(var n=0;t.length>n;n++)if(t[n].getAttribute("data-src")==e)return 0;return-1}function v(e,t,n){for(var r=0;t.length>r;r++){var a=t[n?r+1:r-1];if(t[r].url==e){void 0==a&&(a=n?t[0]:t[t.length-1]),m(a.url,t);for(var o=document.querySelectorAll(".img"),r=0;o.length>r;r++)"gallery/"+o[r].getAttribute("data-src")==e&&(n?G.scrollLeft+=o[r].firstChild.width:G.scrollLeft-=o[r].firstChild.width);break}}}function f(t,n,r){var a=document.createElement("div");if(void 0!=t&&null!=G){void 0==n&&(n=0,I=0,S=0,h(),k=[],R=[]),void 0!=r&&r!==!1||t.length==n+1||(q.className=q.className.replace(/add_inline|add|remove/,""),q.className+=" "+(M.matches?"add":"add_inline"));var o=t[n],l=new Image;void 0!=o&&-1==k.indexOf(o.url)&&(void 0!=r&&r!==!1||t.length==n+1||(q.className=q.className.replace(/add_inline|add|remove/,""),q.className+=" "+(M.matches?"add":"add_inline")),(void 0==r||r===!1)&&(L=n+1),k=o.url,l.onload=function(o){if(H)return H=!1,void 0;var l,i=window.localStorage.getItem("scroll_landscape_"+x);b.remember_scroll_position&&void 0!=i&&(l=JSON.parse(i)),void 0!=l&&l.time+36e5<Date.now()&&window.localStorage.removeItem("scroll_landscape_"+x);var d=document.createAttribute("data-src");d.nodeValue=this.src.substr(this.src.lastIndexOf("/")+1),a.setAttributeNode(d),d=document.createAttribute("class"),d.nodeValue="img",a.setAttributeNode(d);var c=M.matches?s(o.target,null,window.innerWidth):s(o.target,window.innerHeight>V&&b.auto_fit?V>.8*window.innerHeight?V:.8*window.innerHeight:V);a.appendChild(c);var u=null;a.addEventListener("mouseup",function(t){var n=t.target.parentNode,r=localStorage.getItem("token");if(b.admin&&void 0!=r&&null!=r&&(0==z||z==K)){1==n.childNodes.length?n.appendChild(document.createElement("span")):n.removeChild(n.lastChild),null==u&&(u=document.querySelectorAll(".bt_up, .bt_down"));for(var a=e().length,o=0;u.length>o;o++)u[o].className=u[o].className.replace(/add_inline|remove/,"")+" "+(1==a?"add_inline":"remove");var l=document.querySelectorAll(".bt_del")[0];a>0?l.className=l.className.replace(/add_inline|remove/,""):l.className+=" remove"}z=K});var v="";if(a.addEventListener("mousedown",function(e){v=e.screenX+","+e.screenY}),a.addEventListener("mouseup",function(e){var n=localStorage.getItem("token");if((void 0==n||null==n)&&b.fullscreen&&!M.matches&&v==e.screenX+","+e.screenY){var r=document.getElementById("fullscreen");r.className="add",r.addEventListener("click",function(e){if(-1!=e.target.className.indexOf("arrow"))return!1;this.className="remove";var t=r.getElementsByClassName("load")[0];t.className=t.className.replace(/remove/,"add")}),m("gallery/"+e.target.parentNode.getAttribute("data-src"),t)}}),void 0!=r&&r!==!1)R.push(a);else{var p=R.length>0?R.shift():a,h=this.src.substr(this.src.lastIndexOf("/")+1);-1==g(h,document.querySelectorAll(".img"))&&G.insertBefore(p,q)}F=!1,I+=c.width,S+=c.height;var w,y;if(M.matches?(w=S,y=window.innerHeight):(w=I,y=window.innerWidth),t.length!=n+1)if(y>w)f(t,++n);else if(void 0==r||r===!0){var _=!0;null!=l&&l.nb_img>L&&(_=void 0),f(t,++n,_)}void 0==l||r||(G.scrollLeft=l.position),q.className=q.className.replace(/add_inline|add/,"remove")},l.src=o.url)}}function p(e){var t=document.getElementById("menu"),n=t.getElementsByTagName("ul")[0];e=Object.keys(e);for(var r in e)w(e[r],t,n)}function h(){var e=G.getElementsByClassName("img");if(e.length>0)for(;0!=e.length;)G.removeChild(e[e.length-1]);q.className=q.className.replace(/add_inline|add/,"remove")}function w(e,t,n){var r=document.createElement("li"),a=document.createElement("a");a.innerHTML=e;var o=document.createAttribute("href");o.nodeValue="#"+e,a.setAttributeNode(o),a.addEventListener("click",function(){x=e,f(C[e]),localStorage.setItem("section",x)}),r.appendChild(a),n.appendChild(r)}function y(){var e=L||G.getElementsByClassName("img").length,t=C[x].length;t>e&&f(C[x],e,!1)}function _(){var e=window.location.href,t=e.indexOf("#");return-1==t?"":e.substr(t+1)}var b={admin:!0,fullscreen:!0,drag:!0,responsive:!0,remember_scroll_position:!0,min_height:540,auto_fit:!0};if(void 0!=arguments[0]&&"object"==typeof arguments[0])for(var N in b)for(var E in arguments[0])if(N==E){b[N]=arguments[0][E];break}var A=function(){};A.uri=function(){return"api/"},A.http_request=function(e,t,n,r,a){var o=new XMLHttpRequest;o.open(e,t,!0),o.onprogress=a,o.onreadystatechange=function(){if(4==o.readyState){console.log(o.responseText);var e;try{e=JSON.parse(o.responseText)}catch(t){e=null}r(e)}},null!=n?o.send(n):o.send()},A.format_get_data=function(e){var t="",n=!0;for(var r in e)t+=n?"?":"&",t+=r+"="+e[r],n=!1;return t},A.format_post_data=function(e){var t=new FormData;for(var n in e)if("object"==typeof e[n])for(var r=0;e[n].length>r;r++)t.append(n+r,e[n][r]);else t.append(n,e[n]);return t},A.get_ajax=function(e,t,n){if(null!=t){var r=A.format_get_data(t);e+=r}A.http_request("GET",e,null,n)},A.post_ajax=function(e,t,n,r){var a=A.format_post_data(t);A.http_request("POST",e,a,n,r)},A.prototype.login=function(e,t,n){A.get_ajax(A.uri()+"user/login.php",{login:e,password:t},n)},A.prototype.max_file_upload=function(e){A.post_ajax(A.uri()+"max_file_upload.php",{token:localStorage.getItem("token")},e)},A.prototype.add_images=function(e,t,n,r){A.post_ajax(A.uri()+"gallery/add.php",{token:localStorage.getItem("token"),section:e,file:t},n,r)},A.prototype.rm_images=function(e,t,n){A.post_ajax(A.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e,url:t},n)},A.prototype.rm_section=function(e,t){A.post_ajax(A.uri()+"gallery/remove.php",{token:localStorage.getItem("token"),section:e},t)},A.prototype.move_image=function(e,t,n,r){A.post_ajax(A.uri()+"gallery/move.php",{token:localStorage.getItem("token"),section:e,url:t,move:n},r)},document.getElementById("close").addEventListener("click",function(e){return document.getElementById("logbox").className="remove",e.preventDefault?e.preventDefault():e.returnValue=!1,window.history.pushState(null,document.title,".#"+x),!1}),document.getElementById("logbox").addEventListener("submit",function(e){var n=document.getElementById("login").value,r=document.getElementById("password").value,a=new A;return a.login(n,r,function(e){void 0!=e.error?401==e.error?alert("error: login/password incorrect"):alert("error: problem api"):(localStorage.setItem("token",e.token),t(),window.history.pushState(null,document.title,"."))}),e.preventDefault?e.preventDefault():e.returnValue=!1,!1});var C,x,I,S,L,k,B=0,T=0,V=b.min_height,O="login",H=!1,j=document.getElementById("gallery"),q=document.getElementById("load_gallery"),M={matches:!1};b.responsive&&(M=window.matchMedia("only screen and (max-width:480px)"),M.addListener(function(){setTimeout(function(){f(C[x])},100)}));var D=!0;window.onresize=function(){j.offsetWidth>I&&D===!0&&!M.matches&&(y(),D=!1)},document.addEventListener("keyup",function(e){if(37==e.keyCode||39==e.keyCode){var t=document.getElementById("fullscreen").getElementsByTagName("canvas")[0],n="gallery/"+t.getAttribute("data-src");v(n,C[x],39==e.keyCode)}}),document.addEventListener("keydown",function(e){var t=document.getElementById("fullscreen");-1==t.className.indexOf("remove")&&(e.preventDefault?e.preventDefault():e.returnValue=!1)});var z=0,J=60,W=180,X=20,Y="px;",F=!1,G=document.getElementById("gallery"),R=[];null!=G&&G.addEventListener("scroll",function(){G.scrollWidth-G.offsetWidth<=G.scrollLeft&&!F&&(F=!0,y(),D=!0);var e,t=window.localStorage.getItem("scroll_landscape_"+x);void 0!=t&&(e=JSON.parse(t)),!b.remember_scroll_position||void 0!=e&&e.nb_img>L||window.localStorage.setItem("scroll_landscape_"+x,JSON.stringify({position:G.scrollLeft,nb_img:L,time:Date.now()}))}),window.addEventListener("scroll",function(){M.matches&&(window.pageYOffset!=document.documentElement.scrollHeight-document.documentElement.clientHeight||F||(F=!0,y()))}),x=_(),d(function(e){C=e,p(C);var t=Object.keys(C);x=location.search=="?"+O?localStorage.getItem("section")||t[0]:-1!=t.indexOf(x)?x:t[0],null!=G&&f(C[x]),"function"==typeof n&&n()});var P,K,G=document.getElementById("gallery");b.drag&&null!=G&&(G.onmousedown=function(e){return P=!1,2!=e.button?(e.screenY<G.parentNode.offsetHeight-5&&(P=!0),K=e.screenX-this.offsetLeft,!1):void 0},G.onmousemove=function(e){P&&(G.scrollLeft=G.scrollLeft-(e.screenX-K)/7)},G.onmouseup=function(){P&&(P=!1)})};